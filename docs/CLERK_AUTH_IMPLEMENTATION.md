# Clerk è®¤è¯ç³»ç»Ÿå®Œæ•´å®ç°

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäº Clerk çš„å®Œæ•´ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç”¨æˆ·ç™»å½•ã€æ³¨å†Œã€æ•°æ®åº“åŒæ­¥ç­‰åŠŸèƒ½ã€‚å®ç°äº†**ä¸€é”®ç™»å½•åè‡ªåŠ¨åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“**çš„å®Œæ•´æµç¨‹ã€‚

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. è®¤è¯åŠŸèƒ½
- âœ… **é‚®ç®±å¯†ç ç™»å½•/æ³¨å†Œ** - å®Œå…¨å¯ç”¨
- âœ… **ç¬¬ä¸‰æ–¹ç™»å½•æ”¯æŒ** - Google/GitHubï¼ˆéœ€è¦é…ç½®ï¼‰
- âœ… **é‚®ç®±éªŒè¯** - è‡ªåŠ¨å‘é€éªŒè¯ç 
- âœ… **å¯†ç é‡ç½®** - å®Œæ•´çš„å¿˜è®°å¯†ç æµç¨‹
- âœ… **è·¯ç”±ä¿æŠ¤** - è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ

### 2. ç”¨æˆ·åŒæ­¥åŠŸèƒ½
- âœ… **è‡ªåŠ¨åŒæ­¥** - ç™»å½•åè‡ªåŠ¨åˆ›å»º/æ›´æ–°æ•°æ®åº“ç”¨æˆ·
- âœ… **é‡è¯•æœºåˆ¶** - ç½‘ç»œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
- âœ… **é”™è¯¯å¤„ç†** - å‹å¥½çš„é”™è¯¯æç¤ºå’Œæ¢å¤
- âœ… **çŠ¶æ€ç®¡ç†** - å…¨å±€ç”¨æˆ·çŠ¶æ€ç®¡ç†

### 3. ç”¨æˆ·ç•Œé¢
- âœ… **ä¸­æ–‡æœ¬åœ°åŒ–** - æ‰€æœ‰ç•Œé¢å’Œæç¤ºéƒ½æ˜¯ä¸­æ–‡
- âœ… **å“åº”å¼è®¾è®¡** - é€‚é…å„ç§è®¾å¤‡
- âœ… **å‹å¥½æç¤º** - æˆåŠŸã€é”™è¯¯çŠ¶æ€çš„æ¸…æ™°åé¦ˆ
- âœ… **åŠ è½½çŠ¶æ€** - ä¼˜é›…çš„åŠ è½½åŠ¨ç”»

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx           # æ ¹å¸ƒå±€ - åŒ…å«ClerkProviderå’Œè‡ªå®šä¹‰Provider
â”‚   â”œâ”€â”€ provider.tsx         # ç”¨æˆ·çŠ¶æ€ç®¡ç†Provider
â”‚   â””â”€â”€ auth/               # è®¤è¯é¡µé¢
â”‚       â”œâ”€â”€ signin/         # ç™»å½•é¡µé¢
â”‚       â”œâ”€â”€ signup/         # æ³¨å†Œé¡µé¢
â”‚       â”œâ”€â”€ forgot-password/ # å¿˜è®°å¯†ç 
â”‚       â””â”€â”€ reset-password/  # é‡ç½®å¯†ç 
â”œâ”€â”€ components/
â”‚   â””â”€â”€ custom/
â”‚       â””â”€â”€ user-sync.tsx    # ç”¨æˆ·åŒæ­¥ç»„ä»¶
â”œâ”€â”€ services/
â”‚   â””â”€â”€ user/
â”‚       â””â”€â”€ user-service.ts  # ç”¨æˆ·æœåŠ¡å±‚
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ user/
â”‚       â””â”€â”€ user-actions.ts  # ç”¨æˆ·ç›¸å…³çš„Server Actions
â”œâ”€â”€ drizzle/
â”‚   â”œâ”€â”€ db.ts               # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ schemas/
â”‚       â””â”€â”€ users.ts        # ç”¨æˆ·è¡¨ç»“æ„
â””â”€â”€ middleware.ts           # Clerkä¸­é—´ä»¶é…ç½®
```

### æ•°æ®æµ

```mermaid
graph TD
    A[ç”¨æˆ·ç™»å½•/æ³¨å†Œ] --> B[Clerkè®¤è¯]
    B --> C[è®¤è¯æˆåŠŸ]
    C --> D[UserSyncç»„ä»¶è§¦å‘]
    D --> E[è°ƒç”¨syncUserAction]
    E --> F[æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨ç”¨æˆ·]
    F --> G{ç”¨æˆ·å­˜åœ¨?}
    G -->|å¦| H[åˆ›å»ºæ–°ç”¨æˆ·]
    G -->|æ˜¯| I[æ›´æ–°ç”¨æˆ·ä¿¡æ¯]
    H --> J[åŒæ­¥åˆ°ç”¨æˆ·store]
    I --> J
    J --> K[æ˜¾ç¤ºæˆåŠŸæç¤º]
    K --> L[é‡å®šå‘åˆ°dashboard]
```

## ğŸ”§ å…³é”®æ–‡ä»¶è¯´æ˜

### 1. æ ¹å¸ƒå±€é…ç½® (`src/app/layout.tsx`)

```typescript
export default async function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="zh-CN" suppressHydrationWarning>
      <body className={`${MyAppFont.className} font-sans`}>
        <ClerkProvider>
          <Provider>              {/* è‡ªå®šä¹‰ç”¨æˆ·çŠ¶æ€ç®¡ç† */}
            <ThemeProvider>
              {children}
              <Toaster richColors />
            </ThemeProvider>
          </Provider>
        </ClerkProvider>
      </body>
    </html>
  );
}
```

### 2. ç”¨æˆ·åŒæ­¥ç»„ä»¶ (`src/components/custom/user-sync.tsx`)

- **è‡ªåŠ¨è§¦å‘**: ç”¨æˆ·ç™»å½•åè‡ªåŠ¨æ‰§è¡Œ
- **é˜²é‡å¤**: é¿å…é‡å¤åŒæ­¥
- **é”™è¯¯å¤„ç†**: ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
- **ç”¨æˆ·åé¦ˆ**: æ˜¾ç¤ºå‹å¥½çš„æˆåŠŸ/é”™è¯¯æç¤º

### 3. ç”¨æˆ·æœåŠ¡å±‚ (`src/services/user/user-service.ts`)

- `createOrUpdateUser`: åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
- `syncCurrentUserToDatabase`: åŒæ­¥å½“å‰ç”¨æˆ·åˆ°æ•°æ®åº“
- `getUserById`: æ ¹æ®IDè·å–ç”¨æˆ·

### 4. æ•°æ®åº“æ¨¡å¼ (`src/drizzle/schemas/users.ts`)

```typescript
export const users = pgTable('users', {
  id: text('id').primaryKey(),           // Clerkç”¨æˆ·ID
  email: text('email').notNull().unique(), // é‚®ç®±åœ°å€
  fullName: text('full_name'),             // å®Œæ•´å§“å
  avatarUrl: text('avatar_url'),           // å¤´åƒURL
  bio: text('bio'),                        // ç”¨æˆ·ç®€ä»‹
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```typescript
// ç”¨æˆ·åœ¨ /auth/signin ç™»å½•
// â†“
// ClerkéªŒè¯ç”¨æˆ·èº«ä»½
// â†“
// é‡å®šå‘åˆ° /dashboard
// â†“
// UserSyncç»„ä»¶è‡ªåŠ¨è§¦å‘
// â†“
// ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°æ•°æ®åº“
// â†“
// ç”¨æˆ·çŠ¶æ€æ›´æ–°åˆ°å…¨å±€store
```

### 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯

```typescript
import { useUserStore } from '@/store/userStore';

function MyComponent() {
  const { user, isLoading } = useUserStore();
  
  if (isLoading) return <div>åŠ è½½ä¸­...</div>;
  if (!user) return <div>æœªç™»å½•</div>;
  
  return (
    <div>
      <h1>æ¬¢è¿, {user.fullName}!</h1>
      <p>é‚®ç®±: {user.email}</p>
    </div>
  );
}
```

### 3. åœ¨æœåŠ¡å™¨ç«¯éªŒè¯ç”¨æˆ·

```typescript
import { currentUser } from '@clerk/nextjs/server';
import { getUserById } from '@/services/user/user-service';

export default async function ProtectedPage() {
  const clerkUser = await currentUser();
  
  if (!clerkUser) {
    redirect('/auth/signin');
  }
  
  const { user } = await getUserById(clerkUser.id);
  
  return <div>å—ä¿æŠ¤çš„é¡µé¢å†…å®¹</div>;
}
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. è®¿é—®æµ‹è¯•é¡µé¢

è®¿é—® `/auth-test` é¡µé¢å¯ä»¥æ£€æŸ¥è®¤è¯ç³»ç»ŸçŠ¶æ€ï¼š

- âœ… Clerkè®¤è¯çŠ¶æ€
- âœ… æ•°æ®åº“åŒæ­¥çŠ¶æ€  
- âœ… ç³»ç»Ÿå»ºè®®å’Œé”™è¯¯æ’æŸ¥

### 2. å®Œæ•´æµ‹è¯•æµç¨‹

```bash
# 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# 2. è®¿é—®ç™»å½•é¡µé¢
http://localhost:3000/auth/signin

# 3. æ³¨å†Œæ–°ç”¨æˆ·æˆ–ç™»å½•ç°æœ‰ç”¨æˆ·
# 4. æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨é‡å®šå‘åˆ°dashboard
# 5. è®¿é—®æµ‹è¯•é¡µé¢ç¡®è®¤åŒæ­¥çŠ¶æ€
http://localhost:3000/auth-test
```

## âš™ï¸ ç¯å¢ƒé…ç½®

ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®ï¼š

```env
# Clerkè®¤è¯
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/auth/signin
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/auth/signup
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard

# æ•°æ®åº“
DATABASE_URL=postgresql://...
```

## ğŸ”„ ç”¨æˆ·åŒæ­¥é€»è¾‘è¯¦è§£

### åŒæ­¥æ—¶æœº
1. **é¦–æ¬¡ç™»å½•**: ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•æ—¶è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è®°å½•
2. **ä¿¡æ¯æ›´æ–°**: ç”¨æˆ·åœ¨Clerkä¸­æ›´æ–°ä¿¡æ¯åä¸‹æ¬¡ç™»å½•æ—¶åŒæ­¥
3. **é”™è¯¯é‡è¯•**: ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•åŒæ­¥

### åŒæ­¥å†…å®¹
- Clerkç”¨æˆ·ID â†’ æ•°æ®åº“ä¸»é”®
- é‚®ç®±åœ°å€
- å®Œæ•´å§“å (firstName + lastName)
- å¤´åƒURL
- åˆ›å»º/æ›´æ–°æ—¶é—´

### é”™è¯¯å¤„ç†
- æ•°æ®åº“è¿æ¥å¤±è´¥ â†’ è‡ªåŠ¨é‡è¯•
- åŒæ­¥è¶…æ—¶ â†’ æ˜¾ç¤ºå‹å¥½æç¤º
- æƒé™é—®é¢˜ â†’ è®°å½•é”™è¯¯æ—¥å¿—

## ğŸ“‹ å¸¸è§é—®é¢˜

### Q: ç”¨æˆ·ç™»å½•åæ²¡æœ‰è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“ï¼Ÿ
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
2. ç”¨æˆ·è¡¨æ˜¯å¦å·²åˆ›å»º
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
4. è®¿é—® `/auth-test` é¡µé¢æŸ¥çœ‹è¯¦ç»†çŠ¶æ€

### Q: ç¬¬ä¸‰æ–¹ç™»å½•å¤±è´¥ï¼Ÿ
A: éœ€è¦åœ¨Clerkæ§åˆ¶å°é…ç½®OAuthåº”ç”¨ï¼š
1. è®¿é—® [Clerk Dashboard](https://dashboard.clerk.com/)
2. é…ç½®Google/GitHub OAuth
3. è®¾ç½®æ­£ç¡®çš„å›è°ƒURL

### Q: å¦‚ä½•è‡ªå®šä¹‰ç”¨æˆ·å­—æ®µï¼Ÿ
A: ä¿®æ”¹æ•°æ®åº“æ¨¡å¼å¹¶æ›´æ–°åŒæ­¥é€»è¾‘ï¼š
1. åœ¨ `src/drizzle/schemas/users.ts` æ·»åŠ å­—æ®µ
2. æ›´æ–° `user-service.ts` ä¸­çš„åŒæ­¥é€»è¾‘
3. è¿è¡Œæ•°æ®åº“è¿ç§»

## ğŸ‰ æ€»ç»“

è¿™å¥—è®¤è¯ç³»ç»Ÿæä¾›äº†ï¼š

- **å®Œæ•´çš„ç”¨æˆ·è®¤è¯æµç¨‹** - ä»ç™»å½•åˆ°æ•°æ®åº“åŒæ­¥
- **è‡ªåŠ¨åŒ–ç”¨æˆ·ç®¡ç†** - æ— éœ€æ‰‹åŠ¨å¹²é¢„
- **å‹å¥½çš„ç”¨æˆ·ä½“éªŒ** - ä¸­æ–‡ç•Œé¢ï¼Œæ¸…æ™°åé¦ˆ
- **å¥å£®çš„é”™è¯¯å¤„ç†** - ç½‘ç»œé—®é¢˜æ—¶è‡ªåŠ¨æ¢å¤
- **æ˜“äºæ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæ·»åŠ æ–°åŠŸèƒ½

ç”¨æˆ·åªéœ€è¦**ä¸€é”®ç™»å½•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰åç»­çš„åŒæ­¥å’ŒçŠ¶æ€ç®¡ç†å·¥ä½œ**ï¼Œå®ç°äº†çœŸæ­£çš„å³å¼€å³ç”¨ä½“éªŒï¼ 